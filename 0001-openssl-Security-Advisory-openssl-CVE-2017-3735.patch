From c392f0708d588bb3a954d6a9d79e43879161d3fd Mon Sep 17 00:00:00 2001
From: Zhilei Wang <zhilei.wang@windriver.com>
Date: Fri, 24 Nov 2017 09:21:16 +0800
Subject: [PATCH] openssl: Security Advisory - openssl - CVE-2017-3735

Issue: LINCCM-1825

Signed-off-by: Zhilei Wang <zhilei.wang@windriver.com>

diff --git a/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/Makefile b/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/Makefile
index 5b2fab6..8f859d4 100644
--- a/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/Makefile
+++ b/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/Makefile
@@ -8,7 +8,7 @@ PACKAGES         += openssl
 # use of openssl variables and patches.
 
 openssl_TYPE      = SRPM
-openssl_PKG_PATCH_LVL	= 83
+openssl_PKG_PATCH_LVL	= 84
 
 openssl_RPM_NAME =
 openssl_RPM_DEFAULT = openssl 
diff --git a/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/openssl.spec b/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/openssl.spec
index ffab0ba..a024bb2 100644
--- a/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/openssl.spec
+++ b/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/openssl.spec
@@ -211,6 +211,7 @@ Patch634: openssl-CVE-2016-6303.patch
 Patch635: openssl-CVE-2016-6304.patch
 Patch636: openssl-CVE-2016-6306.patch
 Patch637: openssl-CVE-2016-8610.patch
+Patch638: openssl-CVE-2017-3735.patch
 
 License: OpenSSL
 Group: System Environment/Libraries
@@ -416,6 +417,7 @@ from other formats to the formats used by the OpenSSL toolkit.
 %patch635 -p1 -b .CVE-2016-6304
 %patch636 -p1 -b .CVE-2016-6306
 %patch637 -p1 -b .CVE-2016-8610
+%patch638 -p1 -b .CVE-2017-3735
 
 %build 
 # if this is in the environment, bad things happen
diff --git a/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/patches/openssl-CVE-2017-3735.patch b/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/patches/openssl-CVE-2017-3735.patch
new file mode 100644
index 0000000..fabdf27
--- /dev/null
+++ b/layers/updates/RCPL-4.3-WRL.0032/wrll-userspace/core/dist/openssl/patches/openssl-CVE-2017-3735.patch
@@ -0,0 +1,40 @@
+From 7ace05a2130cdce8a9a09ec2fb57eee5d0edc547 Mon Sep 17 00:00:00 2001
+From: wrl43 <wrl43@localhost.localdomain>
+Date: Thu, 23 Nov 2017 14:20:23 +0530
+Subject: [PATCH] From 31c8b265591a0aaa462a1f3eb5770661aaac67db Mon Sep 17
+ 00:00:00 2001 From: Rich Salz <rsalz@openssl.org> Date: Tue, 22 Aug 2017
+ 11:44:41 -0400 Subject: [PATCH] Avoid out-of-bounds read
+
+Fixes CVE 2017-3735
+
+Reviewed-by: Kurt Roeckx <kurt@roeckx.be>
+(Merged from https://github.com/openssl/openssl/pull/4276)
+
+(cherry picked from commit b23171744b01e473ebbfd6edad70c1c3825ffbcd)
+
+diff --git a/crypto/x509v3/v3_addr.c b/crypto/x509v3/v3_addr.c
+index be8ce9a..5853178 100644
+--- a/crypto/x509v3/v3_addr.c
++++ b/crypto/x509v3/v3_addr.c
+@@ -130,12 +130,12 @@ static int length_from_afi(const unsigned afi)
+  */
+ unsigned int v3_addr_get_afi(const IPAddressFamily *f)
+ {
+-  return ((f != NULL &&
+-	   f->addressFamily != NULL &&
+-	   f->addressFamily->data != NULL)
+-	  ? ((f->addressFamily->data[0] << 8) |
+-	     (f->addressFamily->data[1]))
+-	  : 0);
++	if (f == NULL
++	      || f->addressFamily == NULL
++	      || f->addressFamily->data == NULL
++	      || f->addressFamily->length < 2)
++		return 0;
++        return (f->addressFamily->data[0] << 8) | f->addressFamily->data[1];
+ }
+ 
+ /*
+-- 
+2.8.0.GIT
+
-- 
2.11.0

